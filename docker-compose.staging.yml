services:
  iplookup-sg:
    image: nettools-iplookup:latest
    pull_policy: never
    env_file: .env
    ports:
      - "${PORT:-3000}:${PORT:-3000}"
    environment:
      PORT: ${PORT:-3000}
      HOST: ${HOST:-0.0.0.0}
      TRUST_PROXY: ${TRUST_PROXY:-true}
      CORS_ALLOWLIST: ${CORS_ALLOWLIST:-https://nettools.im,https://www.nettools.im}
      RATE_LIMIT_DAILY: ${RATE_LIMIT_DAILY:-24}
      SQLITE_PATH: ${SQLITE_PATH:-/data/app.sqlite}
      RDAP_CACHE_TTL_SECONDS: ${RDAP_CACHE_TTL_SECONDS:-86400}
      RDAP_BASE_URL: ${RDAP_BASE_URL:-https://rdap.org/ip/}
      GEOIP_DB_DIR: ${GEOIP_DB_DIR:-/data/geoip}
      GEOIP_CITY_MMDB: ${GEOIP_CITY_MMDB:-GeoLite2-City.mmdb}
      GEOIP_ASN_MMDB: ${GEOIP_ASN_MMDB:-GeoLite2-ASN.mmdb}
    volumes:
      - ./data:/data
    restart: unless-stopped

  geoip-updater-sg:
    image: nettools-iplookup:latest
    pull_policy: never
    command: ["node", "scripts/update-maxmind.js", "--loop"]
    environment:
      GEOIP_DB_DIR: ${GEOIP_DB_DIR:-/data/geoip}
      MAXMIND_LICENSE_KEY: ${MAXMIND_LICENSE_KEY}
      MAXMIND_EDITION_IDS: ${MAXMIND_EDITION_IDS:-GeoLite2-City,GeoLite2-ASN}
      MAXMIND_UPDATE_INTERVAL_SECONDS: ${MAXMIND_UPDATE_INTERVAL_SECONDS:-86400}
      # Proxy support for MaxMind downloads
      HTTP_PROXY: ${HTTP_PROXY:-${http_proxy:-}}
      HTTPS_PROXY: ${HTTPS_PROXY:-${https_proxy:-}}
      NO_PROXY: ${NO_PROXY:-${no_proxy:-}}
    volumes:
      - ./data:/data
    restart: unless-stopped
